<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col justify-center items-center">

  <div class="bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full">
    <h1 class="text-2xl font-bold mb-4">Payment</h1>

    <div class="mb-4">
      <a href="\shop" class="text-blue-600 hover:underline flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Shop
      </a>
    </div>

    <div class="mb-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="p-4 mb-4 text-sm text-white bg-{{ 'red-500' if category == 'error' else 'green-500' }} rounded-lg">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <!-- Cart Items -->
    <div id="cart-items" class="mb-4">
      <!-- Items will be populated using JavaScript -->
    </div>

    <!-- Total Price -->
    <div class="text-right font-semibold text-lg mb-4">
      Total: ₱<span id="total-price"></span>
    </div>

    <!-- Payment Input -->
    <form action="/payment" method="POST" class="mb-4">
      <input type="hidden" name="cart" id="cart-input">
      <input type="hidden" name="total_amount" id="total-amount-input">
      <label for="inserted-amount" class="block text-gray-700 mb-2">Enter Payment:</label>
      <input 
        type="number" 
        name="inserted_amount" 
        id="inserted-amount" 
        class="w-full p-2 border rounded-lg mb-4" 
        placeholder="Enter amount in PHP" 
        required>
      <button 
        type="submit" 
        class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-500">
        Complete Payment
      </button>
    </form>

    <!-- Medicine Dispensing Buttons -->
    <div class="grid grid-cols-3 gap-4">
      <!-- Dispense buttons will be added dynamically -->
    </div>
  </div>

  <div id="dispense-popup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
      <h2 class="text-xl font-semibold mb-4">Medicine Dispensed</h2>
      <p id="dispense-message">Your medicine has been dispensed.</p>
      <button onclick="closePopup()" class="w-full bg-red-600 text-white py-2 rounded-lg mt-4 hover:bg-red-500">Close</button>
    </div>
  </div>

  <script>
    // Populate cart items and total price
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const cartItemsContainer = document.getElementById('cart-items');
    const totalPriceElement = document.getElementById('total-price');
    const cartInput = document.getElementById('cart-input');
    const totalAmountInput = document.getElementById('total-amount-input');

    cartInput.value = JSON.stringify(cart);
    const totalPrice = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    totalAmountInput.value = totalPrice.toFixed(2);
    totalPriceElement.innerText = totalPrice.toFixed(2);

    if (cart.length === 0) {
      cartItemsContainer.innerHTML = '<p class="text-gray-600">Your cart is empty.</p>';
    } else {
      cart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b');
        itemDiv.innerHTML = 
          `<span class="text-sm font-medium">${item.name}</span>
          <span class="text-sm">₱${(item.price * item.quantity).toFixed(2)}</span>`;
        cartItemsContainer.appendChild(itemDiv);
      });
    }

    // Add medicine dispense buttons
    const buttonsContainer = document.querySelector('.grid');
    cart.forEach(item => {
      const button = document.createElement('button');
      button.classList.add('px-4', 'py-2', 'bg-blue-600', 'text-white', 'rounded-lg', 'hover:bg-blue-500');
      button.innerText = `Dispense ${item.name}`;
      button.onclick = () => {
        alert(`Dispensing ${item.name}`);
        showDispensePopup();
      };
      buttonsContainer.appendChild(button);
    });

    function showDispensePopup() {
      const popup = document.getElementById('dispense-popup');
      popup.classList.remove('hidden');
    }

    function closePopup() {
      const popup = document.getElementById('dispense-popup');
      popup.classList.add('hidden');
    }
  </script>

</body>
</html>
